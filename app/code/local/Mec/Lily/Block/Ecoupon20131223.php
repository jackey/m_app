<?php   class Mec_Lily_Block_Ecoupon extends Mage_Core_Block_Template{  		public function getEcouponData()	{		$data_array = array(			'has_card' => false,			'erp_response' => false,		);			$card = Mage::getSingleton('customer/session')->getCustomer()->getVipCard();		Mage::log($card);		if($card != "" || $card != 0){					$data_array['has_card'] = true;			$id_result = Mage::helper('lily')->QueryIdByVipCard($card);			if($id_result != ""){				$id_result = json_decode($id_result);								if($id_result[0]->code == 0){					$v_id = $id_result[0]->rows;					$v_id = $v_id[0][0];										$ecoupon_result = Mage::helper('lily')->QueryEcouponById($v_id);					if($ecoupon_result != ""){						$ecoupon_result = json_decode($ecoupon_result);						Mage::log($ecoupon_result);						if($ecoupon_result[0]->code == 0){							$card_array = array();							$final_card_data = array();							$ecoupon_results = $ecoupon_result[0]->rows;							Mage::log($ecoupon_results);							foreach($ecoupon_results as $_result){								$card_array[] = $_result[1];							}														$card_array =  array_flip(array_flip($card_array));														foreach($card_array as $card){								$amout = 0;								foreach($ecoupon_results as $_result){									$amout += $_result[3];									if($card == $_result[1]){										$final_card_data[$card] = array(											'LOSE_DATE' => $_result[2],											'VIP_PAYAMT' => $amout,											'CREATIONDATE' => $_result[0]										);									}								}							}																					$data_array['ecoupon_data'] = $final_card_data;							$data_array['erp_response'] = true;						}					}				}			}		}				return $data_array;			}		}