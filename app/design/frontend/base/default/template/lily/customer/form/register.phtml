<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * Create account form template
 *
 * @var $this Mage_Customer_Block_Form_Register
 */
?>

<?php 
    $session = Mage::getSingleton('customer/session');
    $type = Mage_Core_Model_Message::ERROR;

    $messageBlock = $this->getMessagesBlock();
    $items = $messageBlock->getMessages();

?>
<div class="page page_club">
    <div class="club_member_formte">
            <div class="club_tit  club_login_tit">
                <h2><?php echo $this->__('MEMBER<br>REGISTRATION') ?></h2>
            </div>
            <?php if (!count($items)): ?>
            <div class="club_member_rule">
                <div class="club_login_txt">
                    <?php echo $this->__('Welcome to be a member of Lily club! Free 200 points upon registration, countable with off-line purchases. (Limited to Beijing,Shanghai,Wuhan,Shenzhen and Guangzhou.) ')?>
                </div>
                <?php echo $this->getLayout()->createBlock('cms/block')->setBlockId('club-rule')->toHtml(); ?>
                <button id="register-button" class="club_member_rulelink" title="<?php echo $this->__('Agree to the terms and sign up')?>" type="button"><span><span><?php echo $this->__('Agree to the terms and sign up.')?></span></span></button>
            </div>
            <?php endif;?>

            <div class="club-rule-content <?php if (!count($items)) echo 'hide'?>">
            <?php echo $this->getChildHtml('form_fields_before')?>
            <?php echo $messageBlock->getGroupedHtml() ?>
            <?php /* Extensions placeholder */ ?>
            <?php echo $this->getChildHtml('customer.form.register.extra')?>
            <form action="<?php echo $this->getPostActionUrl() ?>" method="post" id="form-validate">
                <div class="club_member_form cs-clear step-1">
                    <div class="cs-clear">
                        <input class="club_login_ipt required-entry" name="telephone" id="telephone" value="<?php echo $this->escapeHtml($this->getFormData()->getTelephone()) ?>" title="<?php echo $this->__('Cell Phone') ?>"  placeholder="<?php echo $this->__('Cell Phone') ?>*" />
                        <input class="club_login_ipt required-entry" id="verify_code" name="verify_code"  title="<?php echo $this->__('Verifying Code') ?>"  placeholder="<?php echo $this->__('Verifying Code') ?>* " />
                    </div>
                    <button type="button" title="<?php //echo $this->__('Get Code') ?><?php echo $this->__('Get a verifying code') ?>" class="club_member_sub" id="get_code"><span><span><?php //echo $this->__('Get Code') ?><?php echo $this->__('Get a verifying code') ?></span></span></button>
                    <button type="button" title="<?php echo $this->__('Verify Code') ?>" class="club_member_sub" id="verfir"><span><span><?php echo $this->__('Verify Code') ?></span></span></button>
                </div>

                <div class="club_memberreg cs-clear fieldset step-2 disable">
                    <input type="hidden" name="success_url" value="<?php echo $this->getSuccessUrl() ?>" />
                    <input type="hidden" name="error_url" value="<?php echo $this->getErrorUrl() ?>" />


                        <div class="club_memberreg_fi cs-clear">
                            <label><?php echo $this->__('Email Address') ?></label>
                            <input type="text" name="email" id="email_address" placeholder="<?php echo $this->__('Email Address') ?>*" value="<?php echo $this->escapeHtml($this->getFormData()->getEmail()) ?>" title="<?php echo $this->__('Email Address') ?>" class="club_login_ipt validate-email required-entry" />
                            <span class="club_memberreg_tips"><?php echo $this->__('The email address is essential to contact with you, please fill in correctly.')?></span>
                        </div>

                        <div class="club_memberreg_fi cs-clear">
                            <label><?php echo $this->__('Password') ?></label>
                            <input type="password" name="password" id="password" placeholder="<?php echo $this->__('Password') ?>*" title="<?php echo $this->__('Password') ?>" class="club_login_ipt required-entry validate-password" />
                            <span class="club_memberreg_tips"><?php echo $this->__('6 to 16 characters')?></span>
                        </div>

                        <div class="club_memberreg_fi cs-clear">
                            <label><?php echo $this->__('Confirm Password') ?></label>
                            <input type="password" name="confirmation" id="confirmation" placeholder="<?php echo $this->__('Confirm Password') ?>*" title="<?php echo $this->__('Confirm Password') ?>" class="club_login_ipt required-entry validate-cpassword" />
                            <span class="club_memberreg_tips"><?php echo $this->__('Please input again')?></span>
                        </div>


                        <div class="club_memberreg_fi cs-clear">
                            <label><?php echo $this->__('Name') ?></label>
                            <input type="text" name="firstname" id="firstname" placeholder="<?php echo $this->__('Name') ?>*" value="" title="<?php echo $this->__('Name') ?>" class="club_login_ipt required-entry" />
                            <span class="club_memberreg_tips"><?php echo $this->__('Please input correctly to get benefits')?></span>
                        </div>

                        <div class="club_memberreg_fi cs-clear">
                            <label><?php echo $this->__('Birthday') ?></label>
                            <input type="text" name="birth" id="birth" placeholder="<?php echo $this->__('Birthday') ?>*" value="" title="<?php echo $this->__('Birthday') ?>" class="club_login_ipt required-entry" />
                            <span class="club_memberreg_tips"><?php echo $this->__('Please input correctly to get a birthday benefit')?></span>
                        </div>

                        <div class="club_memberreg_fi cs-clear">
                            <label><?php echo $this->__('Address') ?></label>
                            <input type="hidden" name="customer_address" id="address" placeholder="<?php echo $this->__('Address') ?>*" value="" title="<?php echo $this->__('Address') ?>" class="club_login_ipt required-entry" />
                            <input type="text" name="province" placeholder="<?php echo $this->__("Province")?>" class="club_login_ipt required-entry" /> 省
                            <input type="text" name="city" placeholder="<?php echo $this->__("City")?>" class="club_login_ipt required-entry" /> 市
                            <input type="text" name="district" placeholder="<?php echo $this->__("District")?>" class="club_login_ipt required-entry" /> 区
                            <input type="text" name="extra" placeholder="<?php echo $this->__("Address")?>" class="club_login_ipt required-entry" />

                            <span class="club_memberreg_tips"><?php echo $this->__('Please input correctly to get benefits')?></span>
                        </div>

                        <div class="club_memberreg_fi cs-clear">
                            <label><?php echo $this->__('Gender') ?></label>
                            <select name="gender" id="gender" placeholder="<?php echo $this->__('Gender') ?>*" class="club_login_ipt required-entry">
                                <option value="1"><?php echo $this->__("Male")?></option>
                                <option value="2"><?php echo $this->__("Female")?></option>
                            </select>

                            <span class="club_memberreg_tips"><?php echo $this->__('Please select  gender')?></span>
                        </div>

                        <div class="club_memberreg_fi cs-clear">
                            <label><?php echo $this->__('ZIP/Post Code') ?></label>
                            <input type="text" name="customer_zip" id="customer_zip" placeholder="<?php echo $this->__('ZIP/Post Code') ?>*" value="" title="<?php echo $this->__('ZIP/Post Code') ?>" class="club_login_ipt required-entry" />
                            <span class="club_memberreg_tips"><?php echo $this->__('Please input correctly to get benefits')?></span>
                        </div>

                        <div class="club_memberreg_fi club_memberreg_edm cs-clear">
                            <?php echo $this->__('Sign Up for Newsletter') ?> <input type="checkbox" name="is_subscribed" title="<?php echo $this->__('Sign Up for Newsletter') ?>" value="1" id="is_subscribed" class="checkbox" />
                        </div>


                </div>


                <div class="buttons-set">
                    <button type="submit" title="<?php echo $this->__('Submit') ?>" class="club_member_sub"><span><span><?php echo $this->__('Submit') ?></span></span></button>
                </div>
            </form>

            </div>
            <script type="text/javascript">
            //<![CDATA[
                var dataForm = new VarienForm('form-validate', true);
                <?php if($this->getShowAddressFields()): ?>
                new RegionUpdater('country', 'region', 'region_id', <?php echo $this->helper('directory')->getRegionJson() ?>, undefined, 'zip');
                <?php endif; ?>
            //]]>

            jQuery.noConflict();
            </script>
            <script type="text/javascript">
                // 地址更新
                (function ($) {
                    $(function () {
                        var address = $("input[name='customer_address']");
                        var province = $("input[name='province']");
                        var city = $("input[name='city']");
                        var district = $("input[name='district']");
                        var extra = $("input[name='extra']");
                        function resetAddress() {
                            var newAddr = province.val() + city.val() + district.val() + extra.val();
                            address.val(newAddr);
                        }
                        province.on("input",function () {
                            resetAddress();
                        });
                        city.on("input", function () {
                            resetAddress();
                        });
                        district.on("input", function () {
                            resetAddress();
                        });
                        extra.on("input", resetAddress);
                    });
                })(jQuery);
                var countdown = 60;
                jQuery(document).ready(function($){

                    $('#register-button').click(function(){
                        $('.club-rule-content').removeClass('hide');
                        $('.club_member_rule').hide();
                        $(this).hide();
                        $('html,body').animate({scrollTop:0});
                    })

                    $(".fieldset input[type='text']").each(function(){
                        if($(this).attr('id') != "telephone" && $(this).attr('id') != "verify_code"){
                            $(this).attr('disabled', 'disabled');
                        }
                    });
                    $(".fieldset input[type='password']").each(function(){
                        $(this).attr('disabled', 'disabled');
                    });

                    $(".fieldset select").each(function(){
                        $(this).attr('disabled', 'disabled');
                    });


                    $('#verfir').click(function(){
                        var _code = $('#verify_code').val();
                        if(_code == ""){
                            $('#verify_code').addClass('validation-failed');
                            return;
                        }else{

                            $('#verify_code').removeClass('validation-failed');
                            $.ajax({
                                url:'<?php echo $this->getUrl('lily/index/verifyCode'); ?>',
                                data:{
                                    code : _code
                                },
                                type:'post',
                                cache:false,
                                dataType:'json',
                                success:function(data) {
                                    if(data.success == false){
                                        alert('<?php echo $this->__('Verify Code Wrong.'); ?>');
                                    }else{
                                        $('.step-2').removeClass('disable');
                                        $(".fieldset input[type='password']").each(function(){
                                            $(this).removeAttr('disabled');
                                        });

                                        $(".fieldset input[type='text']").each(function(){
                                            $(this).removeAttr('disabled');
                                            if($(this).attr('id') == 'birth'){
                                                $(this).attr('onclick', "WdatePicker({onpicked:pickedFunc, maxDate:'<?php echo date('Y-m');?>'})");
                                            }
                                        });

                                        $(".fieldset select").each(function(){
                                            $(this).removeAttr('disabled');
                                        });
                                    }

                                 },
                                 error : function() {
                                     alert('<?php echo $this->__('Some Error'); ?>');
                                 }

                            });
                        }
                    });

                    $('#get_code').click(function(){
                        var tel = $('#telephone').val();
                        if(tel == ""){
                            $('#telephone').addClass('validation-failed');
                            return;
                        }else{
                            $('#telephone').removeClass('validation-failed');

                            $.ajax({
                                url:'<?php echo $this->getUrl('lily/index/sendVerifyfCode'); ?>',
                                data:{
                                    tel : tel,
                                    url : '<?php echo $this->getUrl('lily/index/sendVerifyfCode'); ?>'
                                },
                                type:'post',
                                cache:false,
                                dataType:'json',
                                success:function(data) {
                                    if(data.success == false){
                                        alert('<?php echo $this->__('Verify Code Send Fail.'); ?>');
                                    }

                                 },
                                 error : function() {
                                     alert('<?php echo $this->__('Some Error'); ?>');
                                 }

                            });
                                countdown = 60
                                settime();



                        }
                    });

                });

                function settime() {
                    if (countdown == 0) {
                        jQuery("#get_code").removeAttr("disabled");
                        jQuery("#get_code span span").html('Get');
                        // countdown = 60;
                        clearInterval(countdown);
                        clearTimeout(settime);
                    } else {
                        jQuery("#get_code").attr("disabled", true);
                        jQuery("#get_code span span").html(countdown);
                        countdown--;
                        setTimeout(function(){settime()},1000);
                    }
                }

                function pickedFunc(){
                    jQuery('#year').val($dp.cal.getP('y'));
                    jQuery('#month').val($dp.cal.getP('M'));
                    jQuery('#day').val($dp.cal.getP('d'));
                    jQuery('#dob').val($dp.cal.getP('y') + '-' + $dp.cal.getP('M') + '-' + $dp.cal.getP('d'));

                }
            </script>
        </div>
    </div>
</div>